# =============================================================================
# Module 2 – Lab 3
# File: models/lab3/_lab3_models.yml
#
# Purpose:
# --------
# This YAML file defines dbt "schema tests" and basic model documentation for
# the Lab 3 models. It is part of the repo so students do NOT need to write or
# edit tests during the lab.
#
# dbt Schema Tests (What They Are):
# --------------------------------
# dbt tests are automated checks that validate data quality assumptions.
# In professional environments, these tests are essential because:
#   - Raw data is often messy or inconsistent
#   - Pipelines can silently introduce errors
#   - Data quality problems can cause incorrect dashboards and decisions
#   - Referential integrity is not always enforced at the database level
#
# What This File Enforces:
# ------------------------
# 1) Primary keys are:
#      - not null
#      - unique
# 2) Foreign keys reference real parent rows via relationship tests:
#      - orders.customer_id must exist in customers
#      - order_items.order_id must exist in orders
#      - order_items.product_id must exist in products
#
# Why We Test in dbt Instead of the Database:
# -------------------------------------------
# In many analytics platforms:
#   - Raw/source schemas are not modified (no constraints added)
#   - Warehouses prioritize flexible loading over strict constraints
#   - Integrity is enforced in the modeling layer and monitored continuously
#
# Student Safety Notes:
# ---------------------
# - Students should NOT include passwords, secrets, or .env files in submissions.
# - If a test fails, students should NOT delete the test to "make it pass."
#   Instead, they should interpret what the failure means (this is valuable
#   reasoning evidence in reflection answers).
#
# =============================================================================

version: 2

models:

  # ---------------------------------------------------------------------------
  # STAGING MODELS
  # ---------------------------------------------------------------------------
  # Staging models standardize raw tables into consistent column sets and
  # predictable formats. They should remain lightweight and avoid complex logic.
  # ---------------------------------------------------------------------------

  - name: stg_customers
    description: >
      Staging model for raw customer data. Provides a consistent set of customer
      fields used by downstream core models and marts.
    columns:
      - name: customer_id
        description: >
          Primary identifier for a customer. Must be present and unique to avoid
          duplicated customers and ambiguous joins.
        tests:
          # not_null: prevents missing identifiers (a customer row without an id
          # is not reliably usable)
          - not_null
          # unique: prevents duplicate customer IDs (which would break joins and
          # inflate metrics)
          - unique

      - name: email
        description: >
          Customer email address (potential PII). Included for learning purposes.
          In production, access controls and masking may be required.

      - name: phone_number
        description: >
          Customer phone number (potential PII). Included for learning purposes.
          In production, access controls and monitoring may be required.


  - name: stg_orders
    description: >
      Staging model for raw order data. Defines the order header attributes used
      by the orders fact table and downstream marts.
    columns:
      - name: order_id
        description: >
          Primary identifier for an order. Must be present and unique.
        tests:
          - not_null
          - unique

      - name: customer_id
        description: >
          Foreign key linking an order to a customer.
          This relationship must be valid to ensure orders can always be tied to
          a real customer record.
        tests:
          - not_null
          # relationships: ensures every customer_id in orders exists in customers
          # If this fails, it indicates an "orphan order" (order references a
          # non-existent customer).
          - relationships:
              to: ref('stg_customers')
              field: customer_id

      - name: total_amount
        description: >
          Total order amount (financially sensitive in many organizations).
          Used for reporting and analytics. In production, metric governance
          policies may apply.

      - name: payment_method
        description: >
          Payment metadata (business-sensitive). In real systems, access may be
          restricted and monitored.


  - name: stg_products
    description: >
      Staging model for raw product data. Provides consistent product attributes
      used by downstream models.
    columns:
      - name: product_id
        description: >
          Primary identifier for a product. Must be present and unique.
        tests:
          - not_null
          - unique

      - name: price
        description: >
          Product price (business-sensitive). Included for learning; may require
          access control in production.


  - name: stg_order_items
    description: >
      Staging model for raw order line items. Defines the most granular
      transaction rows in this lab (one row per order_item_id).
    columns:
      - name: order_item_id
        description: >
          Primary identifier for each line item in an order. Must be present and
          unique to prevent duplicated line items and inflated revenue metrics.
        tests:
          - not_null
          - unique

      - name: order_id
        description: >
          Foreign key linking a line item to its parent order.
          This must be valid to ensure every line item belongs to a real order.
        tests:
          - not_null
          - relationships:
              to: ref('stg_orders')
              field: order_id

      - name: product_id
        description: >
          Foreign key linking a line item to the product purchased.
          This must be valid to ensure line items always map to a real product.
        tests:
          - not_null
          - relationships:
              to: ref('stg_products')
              field: product_id


  # ---------------------------------------------------------------------------
  # CORE MODELS
  # ---------------------------------------------------------------------------
  # Core models represent trusted business entities and facts. These are the
  # tables downstream users should rely on instead of raw sources.
  # ---------------------------------------------------------------------------

  - name: dim_customers
    description: >
      Core customer dimension derived from stg_customers. Serves as the trusted
      customer entity for joins and analysis.
    columns:
      - name: customer_id
        description: >
          Primary identifier for customers in the dimension table.
        tests:
          - not_null
          - unique


  - name: dim_products
    description: >
      Core product dimension derived from stg_products. Serves as the trusted
      product entity for joins and analysis.
    columns:
      - name: product_id
        description: >
          Primary identifier for products in the dimension table.
        tests:
          - not_null
          - unique


  - name: fct_orders
    description: >
      Core orders fact table (one row per order). Contains foreign keys to
      dimensions and order-level attributes such as status and total amount.
    columns:
      - name: order_id
        description: >
          Primary identifier for the orders fact table. One row per order_id.
        tests:
          - not_null
          - unique

      - name: customer_id
        description: >
          Foreign key linking each order to a customer dimension record.
          This must be valid to avoid orphaned orders and broken joins.
        tests:
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: customer_id


  - name: fct_order_items
    description: >
      Core order line-item fact table (one row per order_item_id). Contains
      foreign keys to orders and products and includes a derived line_total
      metric (quantity × unit_price).
    columns:
      - name: order_item_id
        description: >
          Primary identifier for order line items.
        tests:
          - not_null
          - unique

      - name: order_id
        description: >
          Foreign key linking each line item to an order in fct_orders.
          This must be valid to prevent orphaned line items.
        tests:
          - not_null
          - relationships:
              to: ref('fct_orders')
              field: order_id

      - name: product_id
        description: >
          Foreign key linking each line item to a product in dim_products.
          This must be valid to prevent orphaned line items.
        tests:
          - not_null
          - relationships:
              to: ref('dim_products')
              field: product_id

      - name: line_total
        description: >
          Derived financial metric: quantity × unit_price.
          Used for aggregations such as daily gross sales.
          In production, revenue definitions may include discounts/refunds/taxes.
